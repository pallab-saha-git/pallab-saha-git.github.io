<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon AWS Multi-Agent Implementation Guide</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Amazon Ember', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ff9900 0%, #232f3e 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 30px 100px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #232f3e 0%, #37475a 100%);
            color: white;
            padding: 50px;
            text-align: center;
            position: relative;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .aws-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #ff9900;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #232f3e;
            font-weight: bold;
        }
        
        .header h1 {
            font-size: 3.5em;
            margin-bottom: 15px;
            font-weight: 300;
        }
        
        .nav-section {
            background: #f8f9fa;
            padding: 30px 50px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            background: white;
            color: #ff9900;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            border: 2px solid #ff9900;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: #ff9900;
            color: white;
        }
        
        .content-section {
            padding: 50px;
        }
        
        .step-section {
            margin-bottom: 60px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 6px solid #ff9900;
        }
        
        .step-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step-title {
            color: #232f3e;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .step-number {
            background: #ff9900;
            color: #232f3e;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .step-content {
            padding: 30px;
        }
        
        .substep {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #146eb4;
        }
        
        .substep h4 {
            color: #232f3e;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .substep-icon {
            color: #146eb4;
            font-size: 1.1em;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Source Code Pro', 'Monaco', 'Courier New', monospace;
            position: relative;
        }
        
        .code-header {
            background: #2d2d30;
            color: #ff9900;
            padding: 10px 20px;
            margin: -20px -20px 15px -20px;
            font-size: 0.9em;
            border-bottom: 1px solid #3e3e42;
            font-weight: bold;
        }
        
        .bash-block {
            background: #2d3748;
            color: #ffffff;
        }
        
        .terraform-block {
            background: #5c4ee5;
            color: #ffffff;
        }
        
        .command-list {
            list-style: none;
            padding: 0;
        }
        
        .command-list li {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff9900;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffd93d;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
            border: 1px solid #146eb4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .global-box {
            background: linear-gradient(135deg, #fff9e6 0%, #ffedcc 100%);
            border: 2px solid #ff9900;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .global-box h4 {
            color: #ff9900;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }
        
        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .region-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .region-card h5 {
            color: #232f3e;
            margin-bottom: 5px;
        }
        
        .region-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2.5em; }
            .nav-links { flex-direction: column; align-items: center; }
            .step-title { font-size: 1.8em; }
            .region-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="aws-logo">AWS</div>
                <h1>Amazon AWS Implementation</h1>
                <h2>Global Scale Multi-Agent Multi-Tenant Build Guide</h2>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-links">
                <a href="#prerequisites" class="nav-link">üìã Prerequisites</a>
                <a href="#global-setup" class="nav-link">üåç Global Setup</a>
                <a href="#bedrock" class="nav-link">üß† Bedrock AI</a>
                <a href="#agents" class="nav-link">ü§ñ Global Agents</a>
                <a href="#infrastructure" class="nav-link">‚ö° Infrastructure</a>
                <a href="#deployment" class="nav-link">üöÄ Deploy</a>
            </div>
        </div>
        
        <div class="content-section">
            <div id="prerequisites" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">1</span>
                        Prerequisites & AWS Account Setup
                    </h3>
                    <p class="step-description">
                        Set up your AWS account with global infrastructure planning and enterprise security.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-cloud substep-icon"></i> AWS Account & Organization</h4>
                        <ul class="command-list">
                            <li>
                                <strong>Create AWS Account</strong>
                                <p>Sign up at <a href="https://aws.amazon.com" target="_blank">aws.amazon.com</a> with business email</p>
                            </li>
                            <li>
                                <strong>Set up AWS Organizations</strong>
                                <p>Create organizational units for: Production, Development, Security, Shared Services</p>
                            </li>
                            <li>
                                <strong>Request Bedrock Model Access</strong>
                                <p>Apply for Claude 3 Sonnet, Claude 3 Haiku, and Titan models access</p>
                            </li>
                            <li>
                                <strong>Enable CloudTrail</strong>
                                <p>Set up organization-wide logging and compliance monitoring</p>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-terminal substep-icon"></i> AWS CLI & Tools Setup</h4>
                        <div class="code-block bash-block">
                            <div class="code-header">Install AWS CLI v2</div>
                            <pre><code># Windows
curl "https://awscli.amazonaws.com/AWSCLIV2.msi" -o "AWSCLIV2.msi"
msiexec /i AWSCLIV2.msi

# macOS
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /

# Linux
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Configure AWS CLI
aws configure
# AWS Access Key ID: YOUR_ACCESS_KEY
# AWS Secret Access Key: YOUR_SECRET_KEY
# Default region name: us-east-1
# Default output format: json

# Install additional tools
pip install boto3 aws-cdk-lib</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-key substep-icon"></i> IAM Roles & Policies</h4>
                        <div class="code-block">
                            <div class="code-header">Create IAM Service Roles</div>
                            <pre><code># Create Lambda execution role
aws iam create-role --role-name ChatbotLambdaRole \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {"Service": "lambda.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }
    ]
  }'

# Attach policies to Lambda role
aws iam attach-role-policy \
  --role-name ChatbotLambdaRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

aws iam attach-role-policy \
  --role-name ChatbotLambdaRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess

# Create custom policy for Bedrock access
aws iam create-policy --policy-name BedrockChatbotPolicy \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream"
        ],
        "Resource": "*"
      }
    ]
  }'</code></pre>
                        </div>
                    </div>
                    
                    <div class="global-box">
                        <h4><i class="fas fa-globe-americas"></i> Global Region Strategy</h4>
                        <p>Plan your multi-region deployment based on user locations and data residency requirements:</p>
                        <div class="region-grid">
                            <div class="region-card">
                                <h5>us-east-1</h5>
                                <p>Primary (N. Virginia)</p>
                            </div>
                            <div class="region-card">
                                <h5>us-west-2</h5>
                                <p>Secondary (Oregon)</p>
                            </div>
                            <div class="region-card">
                                <h5>eu-west-1</h5>
                                <p>Europe (Ireland)</p>
                            </div>
                            <div class="region-card">
                                <h5>ap-southeast-1</h5>
                                <p>Asia Pacific (Singapore)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="warning-box">
                        <h4><i class="fas fa-exclamation-triangle"></i> Important Considerations</h4>
                        <ul>
                            <li><strong>Bedrock Availability:</strong> Not all models available in all regions - plan accordingly</li>
                            <li><strong>Data Residency:</strong> Consider GDPR and other data protection regulations</li>
                            <li><strong>Cost Management:</strong> Set up billing alerts and cost allocation tags</li>
                            <li><strong>Service Limits:</strong> Request limit increases for Lambda, DynamoDB, etc.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="global-setup" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">2</span>
                        Global Infrastructure Setup
                    </h3>
                    <p class="step-description">
                        Deploy core AWS services across multiple regions with Infrastructure as Code.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-code substep-icon"></i> CloudFormation Template</h4>
                        <div class="code-block">
                            <div class="code-header">infrastructure/global-chatbot-stack.yml</div>
                            <pre><code class="language-yaml">AWSTemplateFormatVersion: '2010-09-09'
Description: 'Multi-Agent Multi-Tenant Chatbot Global Infrastructure'

Parameters:
  Environment:
    Type: String
    Default: prod
    AllowedValues: [dev, staging, prod]
  
  ProjectName:
    Type: String
    Default: multi-agent-chatbot

Resources:
  # DynamoDB Global Tables
  TenantsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-tenants-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tenantId
          AttributeType: S
        - AttributeName: domain
          AttributeType: S
      KeySchema:
        - AttributeName: tenantId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: DomainIndex
          KeySchema:
            - AttributeName: domain
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true

  ConversationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-conversations-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: tenantId
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: TenantIndex
          KeySchema:
            - AttributeName: tenantId
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # S3 Buckets
  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-assets-${Environment}-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled

  KnowledgeBaseBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-knowledge-${Environment}-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # API Gateway
  ChatbotAPI:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${ProjectName}-api-${Environment}'
      Description: Multi-Agent Chatbot API
      EndpointConfiguration:
        Types:
          - REGIONAL
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: '*'

  # CloudFront Distribution
  ChatbotCDN:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub '${ProjectName} Global CDN'
        DefaultRootObject: index.html
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt AssetsBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
          - Id: APIOrigin
            DomainName: !Sub '${ChatbotAPI}.execute-api.${AWS::Region}.amazonaws.com'
            CustomOriginConfig:
              HTTPPort: 443
              OriginProtocolPolicy: https-only
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad  # CachingOptimized
        CacheBehaviors:
          - PathPattern: '/api/*'
            TargetOriginId: APIOrigin
            ViewerProtocolPolicy: https-only
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
        PriceClass: PriceClass_All
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

Outputs:
  TenantsTableName:
    Description: 'DynamoDB Tenants Table Name'
    Value: !Ref TenantsTable
    Export:
      Name: !Sub '${ProjectName}-tenants-table-${Environment}'

  ConversationsTableName:
    Description: 'DynamoDB Conversations Table Name'
    Value: !Ref ConversationsTable
    Export:
      Name: !Sub '${ProjectName}-conversations-table-${Environment}'

  APIGatewayId:
    Description: 'API Gateway ID'
    Value: !Ref ChatbotAPI
    Export:
      Name: !Sub '${ProjectName}-api-${Environment}'

  CloudFrontDomain:
    Description: 'CloudFront Distribution Domain'
    Value: !GetAtt ChatbotCDN.DomainName
    Export:
      Name: !Sub '${ProjectName}-cdn-domain-${Environment}'</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-rocket substep-icon"></i> Deploy Infrastructure</h4>
                        <div class="code-block">
                            <div class="code-header">Deploy Global Stack</div>
                            <pre><code># Deploy to primary region (us-east-1)
aws cloudformation create-stack \
  --stack-name multi-agent-chatbot-global \
  --template-body file://infrastructure/global-chatbot-stack.yml \
  --parameters ParameterKey=Environment,ParameterValue=prod \
  --capabilities CAPABILITY_IAM \
  --region us-east-1

# Deploy to secondary regions
aws cloudformation create-stack \
  --stack-name multi-agent-chatbot-global \
  --template-body file://infrastructure/global-chatbot-stack.yml \
  --parameters ParameterKey=Environment,ParameterValue=prod \
  --capabilities CAPABILITY_IAM \
  --region us-west-2

aws cloudformation create-stack \
  --stack-name multi-agent-chatbot-global \
  --template-body file://infrastructure/global-chatbot-stack.yml \
  --parameters ParameterKey=Environment,ParameterValue=prod \
  --capabilities CAPABILITY_IAM \
  --region eu-west-1

# Wait for stack creation
aws cloudformation wait stack-create-complete \
  --stack-name multi-agent-chatbot-global \
  --region us-east-1</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-database substep-icon"></i> Configure Global Tables</h4>
                        <div class="code-block">
                            <div class="code-header">Enable DynamoDB Global Tables</div>
                            <pre><code># Enable Global Tables for Tenants table
aws dynamodb create-global-table \
  --global-table-name multi-agent-chatbot-tenants-prod \
  --replication-group RegionName=us-east-1 RegionName=us-west-2 RegionName=eu-west-1

# Enable Global Tables for Conversations table
aws dynamodb create-global-table \
  --global-table-name multi-agent-chatbot-conversations-prod \
  --replication-group RegionName=us-east-1 RegionName=us-west-2 RegionName=eu-west-1

# Verify global table status
aws dynamodb describe-global-table \
  --global-table-name multi-agent-chatbot-tenants-prod</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="bedrock" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">3</span>
                        Amazon Bedrock AI Setup
                    </h3>
                    <p class="step-description">
                        Configure Amazon Bedrock with Claude 3 models and create AI service integrations.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-brain substep-icon"></i> Request Model Access</h4>
                        <div class="code-block">
                            <div class="code-header">Python - Check Model Availability</div>
                            <pre><code class="language-python">import boto3
import json

def check_bedrock_models():
    """Check available Bedrock models in your region"""
    
    bedrock = boto3.client('bedrock', region_name='us-east-1')
    
    try:
        # List available foundation models
        response = bedrock.list_foundation_models()
        
        available_models = []
        for model in response['modelSummaries']:
            if 'claude' in model['modelId'].lower() or 'titan' in model['modelId'].lower():
                available_models.append({
                    'modelId': model['modelId'],
                    'modelName': model['modelName'],
                    'providerName': model['providerName'],
                    'inputModalities': model.get('inputModalities', []),
                    'outputModalities': model.get('outputModalities', [])
                })
        
        print("Available AI Models:")
        for model in available_models:
            print(f"- {model['modelName']} ({model['modelId']})")
            
        return available_models
        
    except Exception as e:
        print(f"Error checking models: {str(e)}")
        print("You may need to request access to Bedrock models first")

if __name__ == "__main__":
    check_bedrock_models()</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-cog substep-icon"></i> Bedrock Service Implementation</h4>
                        <div class="code-block">
                            <div class="code-header">Python - Bedrock AI Service</div>
                            <pre><code class="language-python">import boto3
import json
import logging
from typing import Dict, List, Optional

class BedrockAIService:
    def __init__(self, region_name: str = 'us-east-1'):
        self.bedrock_runtime = boto3.client(
            service_name='bedrock-runtime',
            region_name=region_name
        )
        
        # Model configurations
        self.models = {
            'claude-3-sonnet': 'anthropic.claude-3-sonnet-20240229-v1:0',
            'claude-3-haiku': 'anthropic.claude-3-haiku-20240307-v1:0',
            'titan-text': 'amazon.titan-text-express-v1'
        }
        
        self.logger = logging.getLogger(__name__)
    
    async def generate_response(self, 
                              messages: List[Dict], 
                              agent_type: str = 'support',
                              temperature: float = 0.3) -> Dict:
        """Generate response using appropriate Bedrock model"""
        
        # Select model based on agent type and complexity
        if agent_type == 'technical' or len(str(messages)) > 2000:
            model_id = self.models['claude-3-sonnet']  # More capable for complex queries
        else:
            model_id = self.models['claude-3-haiku']   # Faster and cheaper for simple queries
        
        try:
            # Prepare the request body
            if 'claude' in model_id:
                body = {
                    "anthropic_version": "bedrock-2023-05-31",
                    "max_tokens": 500,
                    "messages": messages,
                    "temperature": temperature
                }
            else:  # Titan model
                prompt = self._convert_messages_to_prompt(messages)
                body = {
                    "inputText": prompt,
                    "textGenerationConfig": {
                        "maxTokenCount": 500,
                        "temperature": temperature,
                        "stopSequences": []
                    }
                }
            
            # Invoke the model
            response = self.bedrock_runtime.invoke_model(
                body=json.dumps(body),
                modelId=model_id,
                accept='application/json',
                contentType='application/json'
            )
            
            # Parse response
            response_body = json.loads(response.get('body').read())
            
            if 'claude' in model_id:
                text_response = response_body['content'][0]['text']
                usage = response_body.get('usage', {})
            else:  # Titan
                text_response = response_body['results'][0]['outputText']
                usage = response_body.get('inputTextTokenCount', 0)
            
            return {
                'response': text_response,
                'model_id': model_id,
                'usage': usage,
                'success': True
            }
            
        except Exception as e:
            self.logger.error(f"Bedrock API error: {str(e)}")
            return {
                'response': "I'm experiencing technical difficulties. Please try again.",
                'error': str(e),
                'success': False
            }
    
    def _convert_messages_to_prompt(self, messages: List[Dict]) -> str:
        """Convert chat messages to single prompt for Titan models"""
        prompt_parts = []
        
        for message in messages:
            role = message.get('role', 'user')
            content = message.get('content', '')
            
            if role == 'system':
                prompt_parts.append(f"Instructions: {content}")
            elif role == 'user':
                prompt_parts.append(f"Human: {content}")
            elif role == 'assistant':
                prompt_parts.append(f"Assistant: {content}")
        
        prompt_parts.append("Assistant:")
        return "\n\n".join(prompt_parts)
    
    def calculate_cost(self, model_id: str, input_tokens: int, output_tokens: int) -> float:
        """Calculate cost for Bedrock model usage"""
        
        # Current Bedrock pricing (per 1K tokens)
        pricing = {
            'anthropic.claude-3-sonnet-20240229-v1:0': {'input': 0.003, 'output': 0.015},
            'anthropic.claude-3-haiku-20240307-v1:0': {'input': 0.00025, 'output': 0.00125},
            'amazon.titan-text-express-v1': {'input': 0.0008, 'output': 0.0016}
        }
        
        if model_id not in pricing:
            return 0.0
        
        rates = pricing[model_id]
        input_cost = (input_tokens / 1000) * rates['input']
        output_cost = (output_tokens / 1000) * rates['output']
        
        return input_cost + output_cost</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-search substep-icon"></i> Amazon Kendra Setup</h4>
                        <div class="code-block">
                            <div class="code-header">Python - Kendra Knowledge Search</div>
                            <pre><code class="language-python">import boto3
from typing import List, Dict

class KendraKnowledgeService:
    def __init__(self, index_id: str, region_name: str = 'us-east-1'):
        self.kendra = boto3.client('kendra', region_name=region_name)
        self.index_id = index_id
    
    async def search_knowledge(self, query: str, tenant_id: str, max_results: int = 5) -> List[Dict]:
        """Search tenant-specific knowledge using Kendra"""
        
        try:
            # Add tenant filter to ensure data isolation
            response = self.kendra.query(
                IndexId=self.index_id,
                QueryText=query,
                PageSize=max_results,
                AttributeFilter={
                    'EqualsTo': {
                        'Key': 'tenant_id',
                        'Value': {
                            'StringValue': tenant_id
                        }
                    }
                },
                SortingConfiguration={
                    'DocumentAttributeKey': '_score',
                    'SortOrder': 'DESC'
                }
            )
            
            results = []
            for item in response.get('ResultItems', []):
                if item['Type'] in ['ANSWER', 'DOCUMENT']:
                    results.append({
                        'title': item.get('DocumentTitle', {}).get('Text', 'No title'),
                        'excerpt': item.get('DocumentExcerpt', {}).get('Text', ''),
                        'confidence': item.get('ScoreAttributes', {}).get('ScoreConfidence', 'LOW'),
                        'uri': item.get('DocumentURI', ''),
                        'source': item.get('DocumentAttributes', {})
                    })
            
            return results
            
        except Exception as e:
            print(f"Kendra search error: {str(e)}")
            return []
    
    async def create_tenant_datasource(self, tenant_id: str, s3_bucket: str, s3_prefix: str):
        """Create a data source for tenant's knowledge base"""
        
        try:
            response = self.kendra.create_data_source(
                Name=f"TenantKB-{tenant_id}",
                IndexId=self.index_id,
                Type='S3',
                Configuration={
                    'S3Configuration': {
                        'BucketName': s3_bucket,
                        'InclusionPrefixes': [f"{s3_prefix}/{tenant_id}/"],
                        'DocumentsMetadataConfiguration': {
                            'S3Prefix': f"{s3_prefix}/{tenant_id}/metadata/"
                        }
                    }
                },
                Description=f"Knowledge base for tenant {tenant_id}",
                RoleArn=f"arn:aws:iam::{self._get_account_id()}:role/KendraRole",
                Tags=[
                    {
                        'Key': 'TenantId',
                        'Value': tenant_id
                    },
                    {
                        'Key': 'Purpose',
                        'Value': 'ChatbotKnowledgeBase'
                    }
                ]
            )
            
            return response['Id']
            
        except Exception as e:
            print(f"Error creating data source: {str(e)}")
            return None</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="agents" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">4</span>
                        Global Multi-Agent System
                    </h3>
                    <p class="step-description">
                        Build globally distributed agents with regional intelligence and failover capabilities.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-robot substep-icon"></i> Lambda Agent Functions</h4>
                        <div class="code-block">
                            <div class="code-header">agents/global_support_agent/lambda_function.py</div>
                            <pre><code class="language-python">import json
import boto3
import os
from datetime import datetime
from bedrock_service import BedrockAIService
from kendra_service import KendraKnowledgeService

# Initialize services
bedrock = BedrockAIService(region_name=os.environ['AWS_REGION'])
kendra = KendraKnowledgeService(
    index_id=os.environ['KENDRA_INDEX_ID'],
    region_name=os.environ['AWS_REGION']
)
dynamodb = boto3.resource('dynamodb')
tenants_table = dynamodb.Table(os.environ['TENANTS_TABLE'])
conversations_table = dynamodb.Table(os.environ['CONVERSATIONS_TABLE'])

def lambda_handler(event, context):
    """Global Support Agent with regional intelligence"""
    
    try:
        # Parse request
        body = json.loads(event['body']) if isinstance(event.get('body'), str) else event
        
        user_message = body.get('message', '')
        tenant_id = body.get('tenant_id', '')
        session_id = body.get('session_id', '')
        user_location = body.get('location', {})  # For regional customization
        
        # Get tenant configuration
        tenant_config = get_tenant_config(tenant_id)
        
        # Search knowledge base
        knowledge_results = await kendra.search_knowledge(
            query=user_message,
            tenant_id=tenant_id,
            max_results=3
        )
        
        # Get conversation history
        conversation_history = get_conversation_history(session_id, limit=5)
        
        # Generate localized response
        response = await generate_support_response(
            user_message=user_message,
            knowledge_results=knowledge_results,
            conversation_history=conversation_history,
            tenant_config=tenant_config,
            user_location=user_location
        )
        
        # Save interaction
        save_conversation(
            session_id=session_id,
            tenant_id=tenant_id,
            user_message=user_message,
            agent_response=response['text'],
            agent_type='global_support',
            metadata={
                'model_used': response.get('model_id'),
                'confidence': response.get('confidence'),
                'knowledge_sources': len(knowledge_results),
                'user_region': user_location.get('region', 'unknown')
            }
        )
        
        # Check if escalation needed
        if response.get('confidence', 0) < 0.7:
            escalation_response = await handle_escalation(
                tenant_id=tenant_id,
                session_id=session_id,
                user_message=user_message,
                user_location=user_location
            )
            
            return {
                'statusCode': 200,
                'headers': {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                'body': json.dumps({
                    'response': escalation_response['message'],
                    'type': 'escalation',
                    'agent': 'global_support',
                    'escalation_method': escalation_response['method'],
                    'estimated_wait': escalation_response.get('wait_time', '5-10 minutes')
                })
            }
        
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({
                'response': response['text'],
                'type': 'answer',
                'agent': 'global_support',
                'confidence': response.get('confidence', 0.8),
                'sources': [r['title'] for r in knowledge_results[:2]]
            })
        }
        
    except Exception as e:
        print(f"Global Support Agent Error: {str(e)}")
        return {
            'statusCode': 500,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({
                'response': 'I apologize, but I encountered an error. Please try again or contact support.',
                'type': 'error',
                'agent': 'global_support'
            })
        }

async def generate_support_response(user_message, knowledge_results, conversation_history, 
                                  tenant_config, user_location):
    """Generate culturally and regionally appropriate support response"""
    
    # Build context-aware prompt
    knowledge_context = "\n".join([
        f"- {result['title']}: {result['excerpt']}"
        for result in knowledge_results
    ])
    
    # Regional customization
    region = user_location.get('region', 'unknown')
    timezone = user_location.get('timezone', 'UTC')
    language_preference = user_location.get('language', 'en')
    
    # Get regional business hours
    business_hours = get_regional_business_hours(region, timezone)
    
    system_prompt = f"""
    You are a global customer support agent for {tenant_config.get('company_name', 'our company')}.
    
    Customer Location: {region}
    Local Time Zone: {timezone}
    Business Hours: {business_hours}
    Language Preference: {language_preference}
    
    Company Knowledge Base:
    {knowledge_context}
    
    Recent Conversation:
    {format_conversation_history(conversation_history)}
    
    Instructions:
    - Provide helpful, accurate customer support
    - Consider the customer's local time and business hours
    - Be culturally sensitive and appropriate for the {region} region
    - If outside business hours, mention when support will be available
    - Use the knowledge base to provide accurate information
    - If you can't help, suggest appropriate escalation options
    - Keep responses concise but complete
    
    Customer Question: {user_message}
    
    Provide a helpful support response:
    """
    
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_message}
    ]
    
    response = await bedrock.generate_response(
        messages=messages,
        agent_type='support',
        temperature=0.3
    )
    
    # Calculate confidence based on knowledge matching
    confidence = calculate_response_confidence(user_message, knowledge_results)
    response['confidence'] = confidence
    
    return response

def get_regional_business_hours(region, timezone):
    """Get business hours for the customer's region"""
    
    regional_hours = {
        'us': '9 AM - 5 PM EST',
        'eu': '9 AM - 5 PM CET', 
        'apac': '9 AM - 5 PM JST',
        'uk': '9 AM - 5 PM GMT'
    }
    
    return regional_hours.get(region.lower(), '24/7 (global support)')

async def handle_escalation(tenant_id, session_id, user_message, user_location):
    """Handle escalation based on user's region and time"""
    
    region = user_location.get('region', 'unknown')
    
    # Regional escalation methods
    if region.lower() in ['us', 'canada']:
        # Route to US support center
        method = 'phone'
        message = "I'm connecting you with our US support team. You can also call us at +1-800-XXX-XXXX."
    elif region.lower() in ['uk', 'eu', 'europe']:
        # Route to EU support center
        method = 'chat'
        message = "I'm transferring you to our European support team for specialized assistance."
    elif region.lower() in ['apac', 'asia', 'australia']:
        # Route to APAC support center
        method = 'whatsapp'
        message = "I'm connecting you with our Asia-Pacific team via WhatsApp for immediate assistance."
    else:
        # Default to global support
        method = 'email'
        message = "I'm escalating your query to our global support team. You'll receive a response within 2 hours."
    
    # Log escalation
    await log_escalation(tenant_id, session_id, user_message, method, region)
    
    return {
        'method': method,
        'message': message,
        'wait_time': '5-10 minutes' if method in ['chat', 'whatsapp'] else '2 hours'
    }</code></pre>
                        </div>
                    </div>
                    
                    <div class="global-box">
                        <h4><i class="fas fa-globe"></i> Regional Agent Deployment</h4>
                        <div class="code-block">
                            <div class="code-header">Deploy Agents to Multiple Regions</div>
                            <pre><code># Package Lambda function
cd agents/global_support_agent
zip -r global_support_agent.zip .

# Deploy to primary regions
aws lambda create-function \
  --function-name global-support-agent \
  --runtime python3.9 \
  --role arn:aws:iam::ACCOUNT:role/ChatbotLambdaRole \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://global_support_agent.zip \
  --timeout 30 \
  --memory-size 512 \
  --environment Variables='{
    "TENANTS_TABLE":"multi-agent-chatbot-tenants-prod",
    "CONVERSATIONS_TABLE":"multi-agent-chatbot-conversations-prod",
    "KENDRA_INDEX_ID":"your-kendra-index-id"
  }' \
  --region us-east-1

# Replicate to other regions
aws lambda create-function \
  --function-name global-support-agent \
  --runtime python3.9 \
  --role arn:aws:iam::ACCOUNT:role/ChatbotLambdaRole \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://global_support_agent.zip \
  --timeout 30 \
  --memory-size 512 \
  --environment Variables='{
    "TENANTS_TABLE":"multi-agent-chatbot-tenants-prod",
    "CONVERSATIONS_TABLE":"multi-agent-chatbot-conversations-prod",
    "KENDRA_INDEX_ID":"your-kendra-index-id"
  }' \
  --region us-west-2

# Configure API Gateway endpoints for each region
aws apigateway create-resource \
  --rest-api-id YOUR_API_ID \
  --parent-id PARENT_RESOURCE_ID \
  --path-part agents</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-box">
                <h4><i class="fas fa-info-circle"></i> Next Steps</h4>
                <p><strong>Continue with Infrastructure & Deployment:</strong> Complete the AWS implementation with monitoring, security, and production deployment configurations.</p>
                <ul>
                    <li>Set up CloudWatch monitoring and alarms</li>
                    <li>Configure AWS WAF for security</li>
                    <li>Implement CI/CD with CodePipeline</li>
                    <li>Set up Route 53 for global load balancing</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div id="deployment" class="step-section">
        <div class="step-header">
            <h3 class="step-title">
                <span class="step-number">5</span>
                Global Infrastructure & CI/CD Pipeline
            </h3>
            <p class="step-description">
                Deploy global-scale infrastructure with AWS CodePipeline CI/CD and multi-region disaster recovery.
            </p>
        </div>
        <div class="step-content">
            <div class="substep">
                <h4><i class="fas fa-code-branch substep-icon"></i> AWS CodePipeline Setup</h4>
                <div class="code-block">
                    <div class="code-header">buildspec.yml - Global CI/CD Pipeline</div>
                    <pre><code class="language-yaml">version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
      
  build:
    commands:
      - echo Build started on `date`
      
      # Run backend tests
      - cd backend
      - python -m pip install --upgrade pip
      - pip install -r requirements.txt
      - python -m pytest tests/ -v --cov=. --cov-report=xml
      - cd ..
      
      # Run frontend tests  
      - cd frontend
      - npm ci
      - npm run test:ci
      - npm run build
      - cd ..
      
      # Build Docker image
      - echo Building the Docker image...
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG backend/
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $REPOSITORY_URI:$IMAGE_TAG
      
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker image...
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      
      # Update Lambda functions in multiple regions
      - |
        for region in us-east-1 us-west-2 eu-west-1 ap-southeast-1; do
          echo "Updating Lambda functions in $region..."
          aws lambda update-function-code \
            --region $region \
            --function-name chatbot-global-support-agent \
            --image-uri $REPOSITORY_URI:$IMAGE_TAG
            
          aws lambda update-function-code \
            --region $region \
            --function-name chatbot-sales-agent \
            --image-uri $REPOSITORY_URI:$IMAGE_TAG
            
          aws lambda update-function-code \
            --region $region \
            --function-name chatbot-technical-agent \
            --image-uri $REPOSITORY_URI:$IMAGE_TAG
        done
      
      # Update API Gateway deployments
      - |
        for region in us-east-1 us-west-2 eu-west-1 ap-southeast-1; do
          aws apigateway create-deployment \
            --region $region \
            --rest-api-id $(aws apigateway get-rest-apis --region $region --query "items[?name=='multi-agent-chatbot-api'].id" --output text) \
            --stage-name prod
        done

artifacts:
  files:
    - '**/*'
  name: chatbot-build-$(date +%Y-%m-%d)</code></pre>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-cloud substep-icon"></i> Global Infrastructure with CDK</h4>
                <div class="code-block">
                    <div class="code-header">infrastructure/global-stack.py - AWS CDK Global Deployment</div>
                    <pre><code class="language-python">from aws_cdk import (
    Stack,
    aws_lambda as lambda_,
    aws_apigateway as apigateway,
    aws_dynamodb as dynamodb,
    aws_route53 as route53,
    aws_certificatemanager as acm,
    aws_cloudfront as cloudfront,
    aws_s3 as s3,
    aws_iam as iam,
    Duration,
    RemovalPolicy
)
from constructs import Construct

class GlobalChatbotStack(Stack):
    def __init__(self, scope: Construct, construct_id: str, 
                 region: str, is_primary: bool = False, **kwargs) -> None:
        super().__init__(scope, construct_id, **kwargs)
        
        # DynamoDB Global Tables
        self.conversations_table = dynamodb.Table(
            self, f"ConversationsTable-{region}",
            table_name=f"chatbot-conversations-{region}",
            partition_key=dynamodb.Attribute(
                name="sessionId",
                type=dynamodb.AttributeType.STRING
            ),
            sort_key=dynamodb.Attribute(
                name="timestamp",
                type=dynamodb.AttributeType.NUMBER
            ),
            billing_mode=dynamodb.BillingMode.PAY_PER_REQUEST,
            stream=dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            removal_policy=RemovalPolicy.DESTROY,
            global_secondary_indexes=[
                dynamodb.GlobalSecondaryIndex(
                    index_name="TenantIndex",
                    partition_key=dynamodb.Attribute(
                        name="tenantId",
                        type=dynamodb.AttributeType.STRING
                    ),
                    sort_key=dynamodb.Attribute(
                        name="timestamp", 
                        type=dynamodb.AttributeType.NUMBER
                    )
                )
            ]
        )
        
        # Lambda execution role
        lambda_role = iam.Role(
            self, f"LambdaExecutionRole-{region}",
            assumed_by=iam.ServicePrincipal("lambda.amazonaws.com"),
            managed_policies=[
                iam.ManagedPolicy.from_aws_managed_policy_name(
                    "service-role/AWSLambdaBasicExecutionRole"
                ),
                iam.ManagedPolicy.from_aws_managed_policy_name(
                    "AmazonDynamoDBFullAccess"
                ),
                iam.ManagedPolicy.from_aws_managed_policy_name(
                    "AmazonBedrockFullAccess"
                )
            ]
        )
        
        # Global Support Agent Lambda
        self.support_agent = lambda_.Function(
            self, f"GlobalSupportAgent-{region}",
            function_name=f"chatbot-global-support-agent-{region}",
            runtime=lambda_.Runtime.PYTHON_3_11,
            handler="lambda_function.lambda_handler",
            code=lambda_.Code.from_asset("../agents/global_support_agent"),
            timeout=Duration.seconds(30),
            memory_size=512,
            role=lambda_role,
            environment={
                "REGION": region,
                "CONVERSATIONS_TABLE": self.conversations_table.table_name,
                "BEDROCK_REGION": region
            }
        )
        
        # Sales Agent Lambda
        self.sales_agent = lambda_.Function(
            self, f"SalesAgent-{region}",
            function_name=f"chatbot-sales-agent-{region}",
            runtime=lambda_.Runtime.PYTHON_3_11,
            handler="lambda_function.lambda_handler",
            code=lambda_.Code.from_asset("../agents/sales_agent"),
            timeout=Duration.seconds(30),
            memory_size=512,
            role=lambda_role,
            environment={
                "REGION": region,
                "CONVERSATIONS_TABLE": self.conversations_table.table_name
            }
        )
        
        # Technical Agent Lambda
        self.technical_agent = lambda_.Function(
            self, f"TechnicalAgent-{region}",
            function_name=f"chatbot-technical-agent-{region}",
            runtime=lambda_.Runtime.PYTHON_3_11,
            handler="lambda_function.lambda_handler", 
            code=lambda_.Code.from_asset("../agents/technical_agent"),
            timeout=Duration.seconds(45),
            memory_size=1024,
            role=lambda_role,
            environment={
                "REGION": region,
                "CONVERSATIONS_TABLE": self.conversations_table.table_name
            }
        )
        
        # API Gateway
        self.api = apigateway.RestApi(
            self, f"ChatbotAPI-{region}",
            rest_api_name=f"multi-agent-chatbot-api-{region}",
            description="Multi-agent chatbot API",
            default_cors_preflight_options=apigateway.CorsOptions(
                allow_origins=apigateway.Cors.ALL_ORIGINS,
                allow_methods=apigateway.Cors.ALL_METHODS,
                allow_headers=["Content-Type", "Authorization"]
            )
        )
        
        # API Gateway integrations
        agents_resource = self.api.root.add_resource("agents")
        
        support_integration = apigateway.LambdaIntegration(self.support_agent)
        agents_resource.add_resource("support").add_method("POST", support_integration)
        
        sales_integration = apigateway.LambdaIntegration(self.sales_agent)
        agents_resource.add_resource("sales").add_method("POST", sales_integration)
        
        technical_integration = apigateway.LambdaIntegration(self.technical_agent)
        agents_resource.add_resource("technical").add_method("POST", technical_integration)
        
        # CloudWatch Alarms
        self.setup_cloudwatch_alarms(region)
        
        # If this is the primary region, set up global resources
        if is_primary:
            self.setup_global_resources()
    
    def setup_cloudwatch_alarms(self, region):
        """Set up CloudWatch alarms for monitoring"""
        import aws_cdk.aws_cloudwatch as cloudwatch
        
        # Lambda error rate alarm
        cloudwatch.Alarm(
            self, f"LambdaErrorAlarm-{region}",
            alarm_name=f"chatbot-lambda-errors-{region}",
            metric=self.support_agent.metric_errors(),
            threshold=5,
            evaluation_periods=2,
            alarm_description="Lambda function error rate too high"
        )
        
        # API Gateway latency alarm  
        cloudwatch.Alarm(
            self, f"APILatencyAlarm-{region}",
            alarm_name=f"chatbot-api-latency-{region}",
            metric=self.api.metric_latency(),
            threshold=2000,  # 2 seconds
            evaluation_periods=3,
            alarm_description="API Gateway latency too high"
        )
    
    def setup_global_resources(self):
        """Set up global resources like CloudFront, Route 53"""
        
        # S3 bucket for frontend assets
        frontend_bucket = s3.Bucket(
            self, "FrontendAssetsBucket",
            bucket_name="chatbot-frontend-assets-global",
            public_read_access=True,
            website_index_document="index.html",
            removal_policy=RemovalPolicy.DESTROY
        )
        
        # SSL Certificate for CloudFront
        certificate = acm.Certificate(
            self, "ChatbotSSLCert",
            domain_name="chatbot.yourdomain.com",
            subject_alternative_names=["*.chatbot.yourdomain.com"],
            validation=acm.CertificateValidation.from_dns()
        )
        
        # CloudFront Distribution
        distribution = cloudfront.CloudFrontWebDistribution(
            self, "ChatbotCloudFront",
            origin_configs=[
                cloudfront.SourceConfiguration(
                    s3_origin_source=cloudfront.S3OriginConfig(
                        s3_bucket_source=frontend_bucket
                    ),
                    behaviors=[
                        cloudfront.Behavior(
                            is_default_behavior=True,
                            compress=True,
                            allowed_methods=cloudfront.CloudFrontAllowedMethods.GET_HEAD_OPTIONS
                        )
                    ]
                )
            ],
            viewer_certificate=cloudfront.ViewerCertificate.from_acm_certificate(
                certificate,
                aliases=["chatbot.yourdomain.com"]
            ),
            price_class=cloudfront.PriceClass.PRICE_CLASS_ALL
        )

# Deployment script
class GlobalChatbotApp:
    def __init__(self):
        from aws_cdk import App
        self.app = App()
        
        # Deploy to multiple regions
        regions = [
            ("us-east-1", True),   # Primary region
            ("us-west-2", False),  # Secondary regions
            ("eu-west-1", False),
            ("ap-southeast-1", False)
        ]
        
        for region, is_primary in regions:
            GlobalChatbotStack(
                self.app, 
                f"GlobalChatbotStack-{region}",
                region=region,
                is_primary=is_primary,
                env={"region": region}
            )

if __name__ == "__main__":
    app = GlobalChatbotApp()
    app.app.synth()</code></pre>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-chart-line substep-icon"></i> CloudWatch Monitoring & Alerting</h4>
                <div class="code-block">
                    <div class="code-header">monitoring/global-monitoring.py - Comprehensive Monitoring</div>
                    <pre><code class="language-python">import boto3
import json
from datetime import datetime, timedelta

class GlobalMonitoring:
    def __init__(self):
        self.regions = ['us-east-1', 'us-west-2', 'eu-west-1', 'ap-southeast-1']
        self.cloudwatch_clients = {
            region: boto3.client('cloudwatch', region_name=region)
            for region in self.regions
        }
        
    def setup_global_dashboard(self):
        """Create global monitoring dashboard"""
        
        primary_client = self.cloudwatch_clients['us-east-1']
        
        dashboard_body = {
            "widgets": [
                {
                    "type": "metric",
                    "properties": {
                        "metrics": [
                            ["AWS/Lambda", "Invocations", "FunctionName", f"chatbot-global-support-agent-{region}"]
                            for region in self.regions
                        ],
                        "period": 300,
                        "stat": "Sum",
                        "region": "us-east-1",
                        "title": "Global Lambda Invocations"
                    }
                },
                {
                    "type": "metric", 
                    "properties": {
                        "metrics": [
                            ["AWS/Lambda", "Duration", "FunctionName", f"chatbot-global-support-agent-{region}"]
                            for region in self.regions
                        ],
                        "period": 300,
                        "stat": "Average",
                        "region": "us-east-1",
                        "title": "Global Response Times"
                    }
                },
                {
                    "type": "metric",
                    "properties": {
                        "metrics": [
                            ["AWS/Lambda", "Errors", "FunctionName", f"chatbot-global-support-agent-{region}"]
                            for region in self.regions
                        ],
                        "period": 300,
                        "stat": "Sum",
                        "region": "us-east-1", 
                        "title": "Global Error Rates"
                    }
                }
            ]
        }
        
        primary_client.put_dashboard(
            DashboardName="ChatbotGlobalMonitoring",
            DashboardBody=json.dumps(dashboard_body)
        )
        
    def setup_global_alarms(self):
        """Set up alarms across all regions"""
        
        for region in self.regions:
            client = self.cloudwatch_clients[region]
            
            # High error rate alarm
            client.put_metric_alarm(
                AlarmName=f'ChatbotHighErrorRate-{region}',
                ComparisonOperator='GreaterThanThreshold',
                EvaluationPeriods=2,
                MetricName='Errors',
                Namespace='AWS/Lambda',
                Period=300,
                Statistic='Sum',
                Threshold=10.0,
                ActionsEnabled=True,
                AlarmActions=[
                    f'arn:aws:sns:{region}:YOUR_ACCOUNT_ID:chatbot-alerts'
                ],
                AlarmDescription='Chatbot error rate is too high',
                Dimensions=[
                    {
                        'Name': 'FunctionName',
                        'Value': f'chatbot-global-support-agent-{region}'
                    },
                ],
                Unit='Count'
            )
            
            # High latency alarm
            client.put_metric_alarm(
                AlarmName=f'ChatbotHighLatency-{region}',
                ComparisonOperator='GreaterThanThreshold',
                EvaluationPeriods=3,
                MetricName='Duration',
                Namespace='AWS/Lambda',
                Period=300,
                Statistic='Average',
                Threshold=5000.0,  # 5 seconds
                ActionsEnabled=True,
                AlarmActions=[
                    f'arn:aws:sns:{region}:YOUR_ACCOUNT_ID:chatbot-alerts'
                ],
                AlarmDescription='Chatbot response time is too high'
            )
    
    def get_global_metrics(self):
        """Get aggregated metrics across all regions"""
        
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=1)
        
        global_metrics = {
            'total_invocations': 0,
            'total_errors': 0,
            'avg_duration': 0,
            'regional_breakdown': {}
        }
        
        for region in self.regions:
            client = self.cloudwatch_clients[region]
            
            # Get invocations
            invocations_response = client.get_metric_statistics(
                Namespace='AWS/Lambda',
                MetricName='Invocations',
                Dimensions=[
                    {
                        'Name': 'FunctionName',
                        'Value': f'chatbot-global-support-agent-{region}'
                    }
                ],
                StartTime=start_time,
                EndTime=end_time,
                Period=3600,
                Statistics=['Sum']
            )
            
            invocations = sum(point['Sum'] for point in invocations_response['Datapoints'])
            global_metrics['total_invocations'] += invocations
            global_metrics['regional_breakdown'][region] = {
                'invocations': invocations
            }
            
        return global_metrics
    
    def generate_health_report(self):
        """Generate comprehensive health report"""
        
        metrics = self.get_global_metrics()
        
        report = f"""
# Global Chatbot Health Report - {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}

## Global Overview
- **Total Invocations (Last Hour):** {metrics['total_invocations']:,}
- **Total Errors:** {metrics['total_errors']:,}
- **Error Rate:** {(metrics['total_errors']/max(metrics['total_invocations'], 1)*100):.2f}%

## Regional Breakdown
"""
        
        for region, data in metrics['regional_breakdown'].items():
            report += f"- **{region}:** {data['invocations']:,} invocations\n"
        
        return report

if __name__ == "__main__":
    monitoring = GlobalMonitoring()
    monitoring.setup_global_dashboard()
    monitoring.setup_global_alarms()
    print(monitoring.generate_health_report())</code></pre>
                </div>
            </div>
        </div>
    </div>
    
    <div class="step-section">
        <div class="step-header">
            <h3 class="step-title">
                <span class="step-number">6</span>
                Detailed Week-by-Week Global Implementation
            </h3>
            <p class="step-description">
                Complete 8-week implementation timeline for global-scale AWS deployment with multi-region architecture.
            </p>
        </div>
        <div class="step-content">
            <div class="substep">
                <h4><i class="fas fa-calendar substep-icon"></i> Week 3-4: Global Agent Development</h4>
                <div class="command-list">
                    <li>
                        <strong>Day 15-17: Bedrock Integration & Global Routing</strong>
                        <p>Configure Amazon Bedrock with Claude 3 models, implement global intelligent routing with regional awareness</p>
                    </li>
                    <li>
                        <strong>Day 18-20: Global Support Agent</strong>
                        <p>Build globally-aware support agent with regional business hours, multi-language support, cultural adaptation</p>
                    </li>
                    <li>
                        <strong>Day 21-23: International Sales Agent</strong>
                        <p>Develop global sales agent with regional pricing, currency support, territory management, compliance</p>
                    </li>
                    <li>
                        <strong>Day 24-26: Technical & Enterprise Agents</strong>
                        <p>Create technical support agent with global documentation, enterprise agent with advanced workflows</p>
                    </li>
                    <li>
                        <strong>Day 27-28: Global Multi-Tenant Architecture</strong>
                        <p>Implement global tenant isolation, cross-region data replication, disaster recovery procedures</p>
                    </li>
                    <li>
                        <strong>Week 4 Deliverable: ‚úÖ Global multi-agent system with regional intelligence</strong>
                        <p>Complete agent ecosystem with global awareness, regional optimization, and disaster recovery</p>
                    </li>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-desktop substep-icon"></i> Week 5-6: Global Frontend & Advanced Testing</h4>
                <div class="command-list">
                    <li>
                        <strong>Day 29-31: Global Widget Development</strong>
                        <p>Build globally-distributed widget with CDN, regional optimization, multi-language support</p>
                    </li>
                    <li>
                        <strong>Day 32-34: Enterprise Analytics Dashboard</strong>
                        <p>Create global analytics dashboard with QuickSight, regional breakdowns, compliance reporting</p>
                    </li>
                    <li>
                        <strong>Day 35-37: Mobile & API Development</strong>
                        <p>Develop mobile SDK, REST APIs with global load balancing, developer documentation</p>
                    </li>
                    <li>
                        <strong>Day 38-40: Global Testing Strategy</strong>
                        <p>Implement multi-region testing: chaos engineering, disaster recovery testing, global load testing</p>
                    </li>
                    <li>
                        <strong>Day 41-42: Performance & Cost Optimization</strong>
                        <p>Global performance tuning, cost optimization across regions, reserved capacity planning</p>
                    </li>
                    <li>
                        <strong>Week 6 Deliverable: ‚úÖ Global frontend with enterprise features</strong>
                        <p>Production-ready global system with comprehensive testing and optimization</p>
                    </li>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-rocket substep-icon"></i> Week 7-8: Global Deployment & Launch</h4>
                <div class="command-list">
                    <li>
                        <strong>Day 43-45: Multi-Region Infrastructure Deployment</strong>
                        <p>Deploy to 4+ regions with CDK, configure global load balancing, Route 53 health checks</p>
                    </li>
                    <li>
                        <strong>Day 46-48: Global CI/CD Implementation</strong>
                        <p>Configure CodePipeline for multi-region deployment, blue-green deployments, rollback procedures</p>
                    </li>
                    <li>
                        <strong>Day 49-51: Global Security & Compliance</strong>
                        <p>WAF configuration, DDoS protection, compliance validation across regions, security audit</p>
                    </li>
                    <li>
                        <strong>Day 52-54: Global Monitoring & Operations</strong>
                        <p>CloudWatch global dashboards, cross-region alerting, operational runbooks, incident response</p>
                    </li>
                    <li>
                        <strong>Day 55-56: Global Launch & Support</strong>
                        <p>Phased global rollout, 24/7 support setup, global team training, launch celebration</p>
                    </li>
                    <li>
                        <strong>Week 8 Deliverable: ‚úÖ Live global system serving customers worldwide</strong>
                        <p>Fully operational global chatbot with 99.99% uptime SLA and 24/7 monitoring</p>
                    </li>
                </div>
            </div>
            
            <div class="global-box">
                <h4><i class="fas fa-chart-line"></i> AWS Global Advantages</h4>
                <p>Your AWS implementation provides:</p>
                <ul>
                    <li><strong>Global Reach:</strong> 31 regions, 99 availability zones worldwide</li>
                    <li><strong>Advanced AI:</strong> Latest Claude 3 models through Bedrock</li>
                    <li><strong>Enterprise Search:</strong> Kendra with machine learning ranking</li>
                    <li><strong>Disaster Recovery:</strong> Multi-region automatic failover</li>
                    <li><strong>Cost Optimization:</strong> Pay-per-use with reserved capacity options</li>
                </ul>
            </div>
            
            <div class="warning-box">
                <h4><i class="fas fa-globe"></i> Global Deployment Considerations</h4>
                <ul>
                    <li><strong>Latency:</strong> Deploy to regions closest to your users for optimal performance</li>
                    <li><strong>Compliance:</strong> Ensure data residency requirements are met in each region</li>
                    <li><strong>Cost Management:</strong> Monitor cross-region data transfer costs carefully</li>
                    <li><strong>Operations:</strong> Plan for 24/7 operations with follow-the-sun support model</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html> 