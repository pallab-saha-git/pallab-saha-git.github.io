<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Cloud Multi-Agent Implementation Guide</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Google Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 30px 100px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
            color: white;
            padding: 50px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="gcp-impl-grid" width="15" height="15" patternUnits="userSpaceOnUse"><path d="M 15 0 L 0 0 0 15" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23gcp-impl-grid)" /></svg>');
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .google-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #4285f4;
            font-weight: bold;
        }
        
        .header h1 {
            font-size: 3.5em;
            margin-bottom: 15px;
            font-weight: 300;
        }
        
        .header h2 {
            font-size: 1.4em;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .nav-section {
            background: #f8f9fa;
            padding: 30px 50px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            background: white;
            color: #4285f4;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            border: 2px solid #4285f4;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: #4285f4;
            color: white;
        }
        
        .content-section {
            padding: 50px;
        }
        
        .step-section {
            margin-bottom: 60px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 6px solid #4285f4;
        }
        
        .step-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step-title {
            color: #202124;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .step-number {
            background: #4285f4;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .step-description {
            color: #5f6368;
            font-size: 1.1em;
        }
        
        .step-content {
            padding: 30px;
        }
        
        .substep {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #34a853;
        }
        
        .substep h4 {
            color: #202124;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .substep-icon {
            color: #34a853;
            font-size: 1.1em;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            position: relative;
        }
        
        .code-header {
            background: #1a202c;
            color: #a0aec0;
            padding: 10px 20px;
            margin: -20px -20px 15px -20px;
            font-size: 0.9em;
            border-bottom: 1px solid #4a5568;
        }
        
        .command-list {
            list-style: none;
            padding: 0;
        }
        
        .command-list li {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .command-list li strong {
            color: #202124;
            font-size: 1.1em;
        }
        
        .command-list li p {
            color: #5f6368;
            margin-top: 5px;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffd93d;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 1px solid #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .info-box h4 {
            color: #0c5460;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resource-links {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .resource-links h4 {
            color: #202124;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resource-links ul {
            list-style: none;
            padding: 0;
        }
        
        .resource-links li {
            margin: 8px 0;
        }
        
        .resource-links a {
            color: #4285f4;
            text-decoration: none;
            font-weight: 500;
        }
        
        .resource-links a:hover {
            text-decoration: underline;
        }
        
        .timeline {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .timeline-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
        }
        
        .timeline-item.active {
            border-color: #4285f4;
            background: linear-gradient(135deg, #e8f0fe 0%, #f1f8e9 100%);
        }
        
        .timeline-item:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: #4285f4;
            font-weight: bold;
        }
        
        .timeline-item h5 {
            color: #202124;
            margin-bottom: 5px;
        }
        
        .timeline-item p {
            color: #5f6368;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2.5em; }
            .nav-links { flex-direction: column; align-items: center; }
            .timeline { flex-direction: column; }
            .step-title { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="google-logo">G</div>
                <h1>Google Cloud Implementation</h1>
                <h2>Step-by-Step Multi-Agent Multi-Tenant Build Guide</h2>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-links">
                <a href="#prerequisites" class="nav-link">üìã Prerequisites</a>
                <a href="#setup" class="nav-link">‚öôÔ∏è Initial Setup</a>
                <a href="#agents" class="nav-link">ü§ñ Build Agents</a>
                <a href="#frontend" class="nav-link">üíª Frontend</a>
                <a href="#deployment" class="nav-link">üöÄ Deploy</a>
                <a href="#testing" class="nav-link">üß™ Test</a>
            </div>
        </div>
        
        <div class="content-section">
            <div id="prerequisites" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">1</span>
                        Prerequisites & Account Setup
                    </h3>
                    <p class="step-description">
                        Set up your Google Cloud account and enable required services for the multi-agent architecture.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-cloud substep-icon"></i> Google Cloud Account</h4>
                        <ul class="command-list">
                            <li>
                                <strong>Create Google Cloud Account</strong>
                                <p>Go to <a href="https://cloud.google.com" target="_blank">cloud.google.com</a> and sign up for free tier ($300 credit)</p>
                            </li>
                            <li>
                                <strong>Create New Project</strong>
                                <p>Name: "multi-agent-chatbot" | Project ID: "your-company-chatbot-2024"</p>
                            </li>
                            <li>
                                <strong>Enable Billing</strong>
                                <p>Link a payment method (required even for free tier services)</p>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-cogs substep-icon"></i> Enable Required APIs</h4>
                        <div class="code-block">
                            <div class="code-header">Google Cloud Console ‚Üí APIs & Services ‚Üí Library</div>
                            <pre><code># Required APIs to Enable:
‚úì Vertex AI API
‚úì Cloud Functions API  
‚úì Cloud Run API
‚úì Firestore API
‚úì Cloud Storage API
‚úì Cloud CDN API
‚úì Firebase API
‚úì Cloud Build API
‚úì Cloud Logging API
‚úì Cloud Monitoring API</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-terminal substep-icon"></i> Install Google Cloud CLI</h4>
                        <div class="code-block">
                            <div class="code-header">Terminal Commands</div>
                            <pre><code># Windows (PowerShell)
(New-Object Net.WebClient).DownloadFile("https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe", "$env:Temp\GoogleCloudSDKInstaller.exe")
& $env:Temp\GoogleCloudSDKInstaller.exe

# macOS
curl https://sdk.cloud.google.com | bash
exec -l $SHELL

# Ubuntu/Debian
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
sudo apt-get update && sudo apt-get install google-cloud-cli</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-key substep-icon"></i> Authentication Setup</h4>
                        <div class="code-block">
                            <div class="code-header">Initialize and Authenticate</div>
                            <pre><code># Initialize gcloud and select project
gcloud init
gcloud config set project YOUR_PROJECT_ID

# Authenticate
gcloud auth login
gcloud auth application-default login

# Verify setup
gcloud projects list
gcloud config list</code></pre>
                        </div>
                    </div>
                    
                    <div class="warning-box">
                        <h4><i class="fas fa-exclamation-triangle"></i> Important Notes</h4>
                        <ul>
                            <li>Keep your Project ID handy - you'll need it throughout the setup</li>
                            <li>Enable billing even for free tier to access all services</li>
                            <li>Save your service account keys securely</li>
                            <li>Set up budget alerts to monitor costs</li>
                        </ul>
                    </div>
                    
                    <div class="resource-links">
                        <h4><i class="fas fa-link"></i> Useful Resources</h4>
                        <ul>
                            <li><a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                            <li><a href="https://cloud.google.com/sdk/docs/install" target="_blank">Cloud SDK Installation Guide</a></li>
                            <li><a href="https://cloud.google.com/free" target="_blank">Google Cloud Free Tier</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="setup" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">2</span>
                        Core Infrastructure Setup
                    </h3>
                    <p class="step-description">
                        Set up the core Google Cloud services including Vertex AI, Firestore, and Cloud Functions.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-brain substep-icon"></i> Vertex AI Setup</h4>
                        <div class="code-block">
                            <div class="code-header">Enable Vertex AI and Request Model Access</div>
                            <pre><code># Enable Vertex AI API
gcloud services enable aiplatform.googleapis.com

# Create a Vertex AI endpoint region (choose closest to your users)
gcloud config set ai/region us-central1

# Request access to Gemini models (if not already available)
# Go to: https://console.cloud.google.com/vertex-ai/publishers/google/model-garden/
# Request access to:
# - Gemini Pro
# - Gemini Pro Vision  
# - Text Embedding Gecko</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-database substep-icon"></i> Firestore Database Setup</h4>
                        <div class="code-block">
                            <div class="code-header">Create Firestore Database</div>
                            <pre><code># Create Firestore database in Native mode
gcloud firestore databases create --region=us-central1

# Create initial collections structure
# This will be done via code, but here's the structure:
# /tenants/{tenant_id}/sessions/{session_id}
# /tenants/{tenant_id}/knowledge_base/{doc_id}
# /agents/{agent_id}/conversations/{conversation_id}
# /analytics/{tenant_id}/metrics/{date}</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-folder substep-icon"></i> Cloud Storage Setup</h4>
                        <div class="code-block">
                            <div class="code-header">Create Storage Buckets</div>
                            <pre><code># Create main storage bucket for assets
gsutil mb gs://YOUR_PROJECT_ID-chatbot-assets

# Create bucket for tenant-specific data
gsutil mb gs://YOUR_PROJECT_ID-tenant-data

# Create bucket for model artifacts
gsutil mb gs://YOUR_PROJECT_ID-ml-models

# Set appropriate permissions
gsutil iam ch allUsers:objectViewer gs://YOUR_PROJECT_ID-chatbot-assets
gsutil iam ch serviceAccount:YOUR_PROJECT_ID@appspot.gserviceaccount.com:objectAdmin gs://YOUR_PROJECT_ID-tenant-data</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-network-wired substep-icon"></i> Cloud CDN & Load Balancer</h4>
                        <div class="code-block">
                            <div class="code-header">Set up Global Infrastructure</div>
                            <pre><code># Create a global IP address
gcloud compute addresses create chatbot-global-ip --global

# Reserve IP for load balancer
gcloud compute addresses list

# We'll configure the load balancer after deploying services</code></pre>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <h4><i class="fas fa-info-circle"></i> Infrastructure Overview</h4>
                        <p>You're setting up a globally distributed architecture with:</p>
                        <ul>
                            <li><strong>Vertex AI:</strong> For Gemini Pro models and embeddings</li>
                            <li><strong>Firestore:</strong> Multi-tenant NoSQL database</li>
                            <li><strong>Cloud Storage:</strong> File and asset management</li>
                            <li><strong>Cloud CDN:</strong> Global content delivery</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="agents" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">3</span>
                        Build Multi-Agent System
                    </h3>
                    <p class="step-description">
                        Implement the four specialized agents: Support, Sales, Technical, and Router with intelligent routing.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-folder-open substep-icon"></i> Project Structure Setup</h4>
                        <div class="code-block">
                            <div class="code-header">Create Project Directory Structure</div>
                            <pre><code># Create project structure
mkdir multi-agent-chatbot
cd multi-agent-chatbot

# Create directory structure
mkdir -p {
  agents/{support,sales,technical,router},
  shared/{utils,models,database},
  frontend/{widget,admin},
  deployment/{cloudfunctions,cloudrun},
  config,
  tests
}

# Initialize git repository
git init
echo "node_modules/
.env
*.log
.gcloudignore
__pycache__/" > .gitignore</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-robot substep-icon"></i> Agent Router Implementation</h4>
                        <div class="code-block">
                            <div class="code-header">agents/router/main.py</div>
                            <pre><code class="language-python">import functions_framework
import json
from google.cloud import aiplatform
from google.cloud import firestore
import logging

# Initialize clients
aiplatform.init(project="YOUR_PROJECT_ID", location="us-central1")
db = firestore.Client()

@functions_framework.http
def route_agent(request):
    """Route incoming queries to appropriate specialized agent"""
    
    try:
        # Parse request
        request_json = request.get_json()
        user_message = request_json.get('message', '')
        tenant_id = request_json.get('tenant_id', '')
        session_id = request_json.get('session_id', '')
        
        # Classify intent using Gemini Pro
        intent = classify_intent(user_message)
        
        # Route to appropriate agent
        if intent in ['support', 'help', 'issue', 'problem']:
            agent_type = 'support'
        elif intent in ['sales', 'pricing', 'buy', 'purchase', 'demo']:
            agent_type = 'sales'
        elif intent in ['technical', 'api', 'integration', 'development']:
            agent_type = 'technical'
        else:
            agent_type = 'support'  # Default fallback
        
        # Log routing decision
        log_routing_decision(tenant_id, session_id, user_message, agent_type, intent)
        
        return {
            'agent_type': agent_type,
            'intent': intent,
            'confidence': 0.85,
            'session_id': session_id
        }
        
    except Exception as e:
        logging.error(f"Router error: {str(e)}")
        return {'error': str(e), 'agent_type': 'support'}, 500

def classify_intent(message):
    """Use Gemini Pro to classify user intent"""
    
    prompt = f"""
    Classify the following user message into one of these categories:
    - support: General help, issues, problems, complaints
    - sales: Pricing, purchasing, demos, product information
    - technical: API questions, integration help, development
    
    User message: "{message}"
    
    Respond with just the category name.
    """
    
    # Initialize Vertex AI model
    model = aiplatform.Model.list(filter="display_name:gemini-pro")[0]
    
    # Generate prediction
    response = model.predict(
        instances=[{"content": prompt}],
        parameters={"temperature": 0.1, "max_output_tokens": 10}
    )
    
    return response.predictions[0].lower().strip()

def log_routing_decision(tenant_id, session_id, message, agent_type, intent):
    """Log routing decisions for analytics"""
    doc_ref = db.collection('routing_logs').document()
    doc_ref.set({
        'tenant_id': tenant_id,
        'session_id': session_id,
        'message': message[:100],  # Truncate for privacy
        'agent_type': agent_type,
        'intent': intent,
        'timestamp': firestore.SERVER_TIMESTAMP
    })</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-headset substep-icon"></i> Support Agent Implementation</h4>
                        <div class="code-block">
                            <div class="code-header">agents/support/main.py</div>
                            <pre><code class="language-python">import functions_framework
from google.cloud import aiplatform
from google.cloud import firestore
from datetime import datetime
import logging

db = firestore.Client()

@functions_framework.http
def support_agent(request):
    """Handle customer support queries with empathy and accuracy"""
    
    try:
        request_json = request.get_json()
        user_message = request_json.get('message', '')
        tenant_id = request_json.get('tenant_id', '')
        session_id = request_json.get('session_id', '')
        
        # Get tenant-specific knowledge base
        knowledge_context = get_tenant_knowledge(tenant_id)
        
        # Get conversation history
        conversation_history = get_conversation_history(session_id)
        
        # Generate support response
        response = generate_support_response(
            user_message, 
            knowledge_context, 
            conversation_history,
            tenant_id
        )
        
        # Save conversation
        save_conversation(session_id, 'user', user_message)
        save_conversation(session_id, 'support_agent', response['text'])
        
        # Check if escalation needed
        if response['confidence'] < 0.7:
            return {
                'response': response['text'],
                'type': 'escalation',
                'agent': 'support',
                'escalation_reason': 'Low confidence in response',
                'suggested_action': 'human_handoff'
            }
        
        return {
            'response': response['text'],
            'type': 'answer',
            'agent': 'support',
            'confidence': response['confidence']
        }
        
    except Exception as e:
        logging.error(f"Support agent error: {str(e)}")
        return {'error': str(e)}, 500

def generate_support_response(message, knowledge, history, tenant_id):
    """Generate contextual support response using Gemini Pro"""
    
    # Build context-aware prompt
    prompt = f"""
    You are a helpful customer support agent for {get_tenant_name(tenant_id)}.
    
    Company Knowledge Base:
    {knowledge}
    
    Conversation History:
    {format_conversation_history(history)}
    
    Customer Question: {message}
    
    Instructions:
    - Be empathetic and helpful
    - Use the knowledge base to provide accurate information
    - If you don't know something, say so honestly
    - Suggest escalation for complex technical issues
    - Keep responses concise but complete
    
    Provide a helpful response:
    """
    
    model = aiplatform.Model.list(filter="display_name:gemini-pro")[0]
    
    response = model.predict(
        instances=[{"content": prompt}],
        parameters={
            "temperature": 0.3,
            "max_output_tokens": 500,
            "top_p": 0.8
        }
    )
    
    response_text = response.predictions[0]
    
    # Calculate confidence based on knowledge match
    confidence = calculate_confidence(message, knowledge)
    
    return {
        'text': response_text,
        'confidence': confidence
    }

def get_tenant_knowledge(tenant_id):
    """Retrieve tenant-specific knowledge base"""
    docs = db.collection('tenants').document(tenant_id).collection('knowledge_base').stream()
    knowledge_items = []
    
    for doc in docs:
        data = doc.to_dict()
        knowledge_items.append(f"- {data.get('title', '')}: {data.get('content', '')}")
    
    return "\n".join(knowledge_items)

def calculate_confidence(message, knowledge):
    """Calculate response confidence based on knowledge matching"""
    # Simple keyword matching - could be enhanced with embedding similarity
    message_words = set(message.lower().split())
    knowledge_words = set(knowledge.lower().split())
    
    overlap = len(message_words.intersection(knowledge_words))
    confidence = min(0.9, overlap / max(len(message_words), 1) * 2)
    
    return max(0.3, confidence)  # Minimum confidence threshold</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-chart-line substep-icon"></i> Sales Agent Implementation</h4>
                        <div class="code-block">
                            <div class="code-header">agents/sales/main.py</div>
                            <pre><code class="language-python">import functions_framework
from google.cloud import aiplatform
from google.cloud import firestore
import json

db = firestore.Client()

@functions_framework.http
def sales_agent(request):
    """Handle sales inquiries with lead qualification and product recommendations"""
    
    try:
        request_json = request.get_json()
        user_message = request_json.get('message', '')
        tenant_id = request_json.get('tenant_id', '')
        session_id = request_json.get('session_id', '')
        
        # Get product catalog for tenant
        product_info = get_tenant_products(tenant_id)
        
        # Get lead information if available
        lead_data = get_lead_data(session_id)
        
        # Generate sales response
        response = generate_sales_response(
            user_message,
            product_info,
            lead_data,
            tenant_id
        )
        
        # Update lead scoring
        update_lead_score(session_id, user_message, response['intent'])
        
        # Save interaction
        save_conversation(session_id, 'user', user_message)
        save_conversation(session_id, 'sales_agent', response['text'])
        
        return {
            'response': response['text'],
            'type': 'sales',
            'agent': 'sales',
            'lead_score': response.get('lead_score', 0),
            'next_action': response.get('next_action', 'continue_conversation')
        }
        
    except Exception as e:
        return {'error': str(e)}, 500

def generate_sales_response(message, products, lead_data, tenant_id):
    """Generate sales-focused response with product recommendations"""
    
    prompt = f"""
    You are a knowledgeable sales agent for {get_tenant_name(tenant_id)}.
    
    Available Products/Services:
    {products}
    
    Lead Information:
    {json.dumps(lead_data, indent=2) if lead_data else "New prospect"}
    
    Customer Inquiry: {message}
    
    Instructions:
    - Focus on understanding customer needs
    - Recommend relevant products/services
    - Ask qualifying questions to better understand requirements
    - Provide pricing information when appropriate
    - Be consultative, not pushy
    - Suggest demos or consultations for complex needs
    
    Provide a helpful sales response:
    """
    
    model = aiplatform.Model.list(filter="display_name:gemini-pro")[0]
    
    response = model.predict(
        instances=[{"content": prompt}],
        parameters={
            "temperature": 0.4,
            "max_output_tokens": 400
        }
    )
    
    # Analyze sales intent
    intent = analyze_sales_intent(message)
    lead_score = calculate_lead_score(message, intent)
    
    return {
        'text': response.predictions[0],
        'intent': intent,
        'lead_score': lead_score,
        'next_action': determine_next_action(intent, lead_score)
    }

def analyze_sales_intent(message):
    """Analyze the sales intent from customer message"""
    intent_keywords = {
        'pricing': ['price', 'cost', 'pricing', 'how much', 'budget'],
        'demo': ['demo', 'demonstration', 'show me', 'trial'],
        'comparison': ['compare', 'vs', 'versus', 'alternative'],
        'ready_to_buy': ['buy', 'purchase', 'order', 'get started'],
        'information': ['learn', 'information', 'tell me about']
    }
    
    message_lower = message.lower()
    
    for intent, keywords in intent_keywords.items():
        if any(keyword in message_lower for keyword in keywords):
            return intent
    
    return 'general'

def calculate_lead_score(message, intent):
    """Calculate lead score based on message content and intent"""
    score = 0
    
    # Base score by intent
    intent_scores = {
        'ready_to_buy': 90,
        'pricing': 70,
        'demo': 60,
        'comparison': 50,
        'information': 30,
        'general': 20
    }
    
    score = intent_scores.get(intent, 20)
    
    # Adjust based on urgency indicators
    urgency_keywords = ['urgent', 'asap', 'immediately', 'soon', 'quickly']
    if any(keyword in message.lower() for keyword in urgency_keywords):
        score += 20
    
    return min(100, score)</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-wrench substep-icon"></i> Technical Agent Implementation</h4>
                        <div class="code-block">
                            <div class="code-header">agents/technical/main.py</div>
                            <pre><code class="language-python">import functions_framework
from google.cloud import aiplatform
from google.cloud import firestore
import re

db = firestore.Client()

@functions_framework.http
def technical_agent(request):
    """Handle technical support with code examples and detailed solutions"""
    
    try:
        request_json = request.get_json()
        user_message = request_json.get('message', '')
        tenant_id = request_json.get('tenant_id', '')
        session_id = request_json.get('session_id', '')
        
        # Get technical documentation
        tech_docs = get_technical_documentation(tenant_id)
        
        # Classify technical complexity
        complexity = classify_technical_complexity(user_message)
        
        # Generate technical response
        response = generate_technical_response(
            user_message,
            tech_docs,
            complexity,
            tenant_id
        )
        
        # Save technical interaction
        save_technical_interaction(session_id, user_message, response, complexity)
        
        # Check if human expert needed
        if complexity == 'high' or response['confidence'] < 0.6:
            return {
                'response': response['text'],
                'type': 'technical_escalation',
                'agent': 'technical',
                'complexity': complexity,
                'escalation_reason': 'Complex technical issue requiring expert review'
            }
        
        return {
            'response': response['text'],
            'type': 'technical_answer',
            'agent': 'technical',
            'complexity': complexity,
            'includes_code': response.get('includes_code', False)
        }
        
    except Exception as e:
        return {'error': str(e)}, 500

def generate_technical_response(message, docs, complexity, tenant_id):
    """Generate detailed technical response with code examples"""
    
    prompt = f"""
    You are a senior technical support engineer for {get_tenant_name(tenant_id)}.
    
    Technical Documentation:
    {docs}
    
    Technical Question: {message}
    Complexity Level: {complexity}
    
    Instructions:
    - Provide detailed, accurate technical information
    - Include code examples when relevant
    - Reference official documentation
    - Suggest best practices
    - For high complexity issues, recommend expert consultation
    - Format code with proper syntax highlighting markers
    
    Provide a comprehensive technical response:
    """
    
    model = aiplatform.Model.list(filter="display_name:gemini-pro")[0]
    
    response = model.predict(
        instances=[{"content": prompt}],
        parameters={
            "temperature": 0.2,  # Lower temperature for technical accuracy
            "max_output_tokens": 800
        }
    )
    
    response_text = response.predictions[0]
    
    return {
        'text': response_text,
        'confidence': calculate_technical_confidence(message, docs),
        'includes_code': bool(re.search(r'```|`[^`]+`', response_text))
    }

def classify_technical_complexity(message):
    """Classify the complexity of technical question"""
    
    high_complexity_indicators = [
        'architecture', 'scaling', 'performance', 'optimization',
        'security', 'integration', 'custom', 'advanced'
    ]
    
    medium_complexity_indicators = [
        'api', 'configuration', 'setup', 'deployment',
        'authentication', 'database', 'webhook'
    ]
    
    message_lower = message.lower()
    
    if any(indicator in message_lower for indicator in high_complexity_indicators):
        return 'high'
    elif any(indicator in message_lower for indicator in medium_complexity_indicators):
        return 'medium'
    else:
        return 'low'

def calculate_technical_confidence(message, documentation):
    """Calculate confidence based on documentation coverage"""
    # Enhanced confidence calculation for technical queries
    doc_words = set(documentation.lower().split())
    message_words = set(message.lower().split())
    
    # Technical terms boost confidence
    technical_terms = {
        'api', 'endpoint', 'authentication', 'webhook', 'json',
        'rest', 'http', 'ssl', 'oauth', 'token', 'sdk'
    }
    
    tech_overlap = len(message_words.intersection(technical_terms))
    doc_overlap = len(message_words.intersection(doc_words))
    
    base_confidence = min(0.9, (doc_overlap + tech_overlap) / max(len(message_words), 1))
    
    return max(0.4, base_confidence)</code></pre>
                        </div>
                    </div>
                    
                    <div class="warning-box">
                        <h4><i class="fas fa-exclamation-triangle"></i> Agent Development Tips</h4>
                        <ul>
                            <li><strong>Test Each Agent Individually:</strong> Deploy and test each agent separately before integration</li>
                            <li><strong>Monitor Token Usage:</strong> Gemini Pro costs by token - optimize prompts for efficiency</li>
                            <li><strong>Implement Fallbacks:</strong> Always have fallback responses for edge cases</li>
                            <li><strong>Log Everything:</strong> Comprehensive logging helps with debugging and optimization</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="frontend" class="step-section">
                <div class="step-header">
                    <h3 class="step-title">
                        <span class="step-number">4</span>
                        Frontend Widget Development
                    </h3>
                    <p class="step-description">
                        Build the multi-tenant chatbot widget that can be embedded in any website with automatic tenant detection.
                    </p>
                </div>
                <div class="step-content">
                    <div class="substep">
                        <h4><i class="fas fa-code substep-icon"></i> Universal Chatbot Widget</h4>
                        <div class="code-block">
                            <div class="code-header">frontend/widget/chatbot-widget.js</div>
                            <pre><code class="language-javascript">class MultiTenantChatbot {
    constructor(config) {
        this.config = {
            apiEndpoint: config.apiEndpoint || 'https://YOUR_PROJECT_ID.cloudfunctions.net',
            tenantId: config.tenantId || this.detectTenant(),
            position: config.position || 'bottom-right',
            primaryColor: config.primaryColor || '#4285f4',
            theme: config.theme || 'light',
            ...config
        };
        
        this.sessionId = this.generateSessionId();
        this.isOpen = false;
        this.messageQueue = [];
        
        this.init();
    }
    
    detectTenant() {
        // Auto-detect tenant from domain or subdomain
        const hostname = window.location.hostname;
        
        // Check for subdomain pattern: tenant.yourdomain.com
        const subdomainMatch = hostname.match(/^([^.]+)\.([^.]+\.[^.]+)$/);
        if (subdomainMatch) {
            return subdomainMatch[1];
        }
        
        // Check for registered domains
        const domainTenantMap = {
            'example.com': 'example-tenant',
            'acme.com': 'acme-corp',
            'localhost': 'development'
        };
        
        return domainTenantMap[hostname] || 'default';
    }
    
    init() {
        this.createWidget();
        this.setupEventListeners();
        this.loadTenantBranding();
    }
    
    createWidget() {
        // Create widget container
        this.container = document.createElement('div');
        this.container.id = 'multi-agent-chatbot';
        this.container.className = `chatbot-widget ${this.config.position} ${this.config.theme}`;
        
        this.container.innerHTML = `
            <div class="chatbot-toggle" id="chatbot-toggle">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 13.54 2.36 14.97 3.03 16.26L1 23L7.74 20.97C9.03 21.64 10.46 22 12 22C17.52 22 22 17.52 22 12S17.52 2 12 2Z" fill="currentColor"/>
                </svg>
                <div class="notification-badge" id="notification-badge" style="display: none;">1</div>
            </div>
            
            <div class="chatbot-window" id="chatbot-window" style="display: none;">
                <div class="chatbot-header">
                    <div class="header-info">
                        <div class="agent-avatar" id="agent-avatar">ü§ñ</div>
                        <div class="agent-details">
                            <div class="agent-name" id="agent-name">AI Assistant</div>
                            <div class="agent-status" id="agent-status">Online</div>
                        </div>
                    </div>
                    <button class="close-btn" id="close-btn">√ó</button>
                </div>
                
                <div class="chatbot-messages" id="chatbot-messages">
                    <div class="welcome-message">
                        <div class="message agent-message">
                            <div class="message-content">
                                üëã Hi! I'm your AI assistant. How can I help you today?
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chatbot-input">
                    <div class="typing-indicator" id="typing-indicator" style="display: none;">
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <span>AI is typing...</span>
                    </div>
                    <div class="input-container">
                        <input type="text" id="message-input" placeholder="Type your message..." maxlength="500">
                        <button id="send-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Apply custom styling
        this.applyCustomStyling();
        
        // Add to page
        document.body.appendChild(this.container);
    }
    
    async loadTenantBranding() {
        try {
            const response = await fetch(`${this.config.apiEndpoint}/get-tenant-branding`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenant_id: this.config.tenantId })
            });
            
            if (response.ok) {
                const branding = await response.json();
                this.applyBranding(branding);
            }
        } catch (error) {
            console.warn('Could not load tenant branding:', error);
        }
    }
    
    applyBranding(branding) {
        if (branding.primaryColor) {
            document.documentElement.style.setProperty('--chatbot-primary-color', branding.primaryColor);
        }
        
        if (branding.logo) {
            const avatar = document.getElementById('agent-avatar');
            avatar.innerHTML = `<img src="${branding.logo}" alt="Assistant" style="width: 100%; height: 100%; border-radius: 50%;">`;
        }
        
        if (branding.welcomeMessage) {
            const welcomeMessage = this.container.querySelector('.welcome-message .message-content');
            welcomeMessage.textContent = branding.welcomeMessage;
        }
    }
    
    setupEventListeners() {
        const toggle = document.getElementById('chatbot-toggle');
        const closeBtn = document.getElementById('close-btn');
        const sendBtn = document.getElementById('send-btn');
        const messageInput = document.getElementById('message-input');
        
        toggle.addEventListener('click', () => this.toggleWidget());
        closeBtn.addEventListener('click', () => this.closeWidget());
        sendBtn.addEventListener('click', () => this.sendMessage());
        
        messageInput.addEventListener('input', (e) => {
            sendBtn.disabled = !e.target.value.trim();
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
    }
    
    async sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Clear input and disable send button
        messageInput.value = '';
        document.getElementById('send-btn').disabled = true;
        
        // Add user message to chat
        this.addMessage(message, 'user');
        
        // Show typing indicator
        this.showTypingIndicator();
        
        try {
            // Route message to appropriate agent
            const routingResponse = await this.routeMessage(message);
            const agentType = routingResponse.agent_type;
            
            // Update agent indicator
            this.updateCurrentAgent(agentType);
            
            // Get response from specific agent
            const agentResponse = await this.getAgentResponse(message, agentType);
            
            // Hide typing indicator
            this.hideTypingIndicator();
            
            // Add agent response
            this.addMessage(agentResponse.response, 'agent', agentType);
            
            // Handle special response types
            if (agentResponse.type === 'escalation') {
                this.handleEscalation(agentResponse);
            }
            
        } catch (error) {
            this.hideTypingIndicator();
            this.addMessage('Sorry, I encountered an error. Please try again.', 'agent', 'error');
            console.error('Chat error:', error);
        }
    }
    
    async routeMessage(message) {
        const response = await fetch(`${this.config.apiEndpoint}/route-agent`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                tenant_id: this.config.tenantId,
                session_id: this.sessionId
            })
        });
        
        if (!response.ok) {
            throw new Error('Routing failed');
        }
        
        return await response.json();
    }
    
    async getAgentResponse(message, agentType) {
        const agentEndpoints = {
            'support': '/support-agent',
            'sales': '/sales-agent',
            'technical': '/technical-agent'
        };
        
        const endpoint = agentEndpoints[agentType] || '/support-agent';
        
        const response = await fetch(`${this.config.apiEndpoint}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                tenant_id: this.config.tenantId,
                session_id: this.sessionId
            })
        });
        
        if (!response.ok) {
            throw new Error('Agent response failed');
        }
        
        return await response.json();
    }
    
    addMessage(content, sender, agentType = null) {
        const messagesContainer = document.getElementById('chatbot-messages');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = `message ${sender}-message`;
        
        if (sender === 'agent' && agentType) {
            messageDiv.classList.add(`${agentType}-agent`);
        }
        
        messageDiv.innerHTML = `
            <div class="message-content">${this.formatMessage(content)}</div>
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    formatMessage(content) {
        // Format code blocks
        content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
            return `<pre><code class="language-${lang || 'text'}">${this.escapeHtml(code.trim())}</code></pre>`;
        });
        
        // Format inline code
        content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // Format links
        content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
        
        // Format line breaks
        content = content.replace(/\n/g, '<br>');
        
        return content;
    }
    
    updateCurrentAgent(agentType) {
        const agentName = document.getElementById('agent-name');
        const agentAvatar = document.getElementById('agent-avatar');
        
        const agentInfo = {
            'support': { name: 'Support Agent', emoji: 'üéß' },
            'sales': { name: 'Sales Agent', emoji: 'üíº' },
            'technical': { name: 'Technical Agent', emoji: 'üîß' },
            'router': { name: 'AI Assistant', emoji: 'ü§ñ' }
        };
        
        const info = agentInfo[agentType] || agentInfo.router;
        agentName.textContent = info.name;
        agentAvatar.textContent = info.emoji;
    }
    
    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Additional utility methods...
    showTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'flex';
    }
    
    hideTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'none';
    }
    
    toggleWidget() {
        const window = document.getElementById('chatbot-window');
        if (this.isOpen) {
            this.closeWidget();
        } else {
            this.openWidget();
        }
    }
    
    openWidget() {
        document.getElementById('chatbot-window').style.display = 'block';
        this.isOpen = true;
        document.getElementById('message-input').focus();
    }
    
    closeWidget() {
        document.getElementById('chatbot-window').style.display = 'none';
        this.isOpen = false;
    }
}</code></pre>
                        </div>
                    </div>
                    
                    <div class="substep">
                        <h4><i class="fas fa-paint-brush substep-icon"></i> Widget Styling</h4>
                        <div class="code-block">
                            <div class="code-header">frontend/widget/chatbot-styles.css</div>
                            <pre><code class="language-css">:root {
    --chatbot-primary-color: #4285f4;
    --chatbot-secondary-color: #34a853;
    --chatbot-background: #ffffff;
    --chatbot-text: #202124;
    --chatbot-border: #e8eaed;
    --chatbot-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.chatbot-widget {
    position: fixed;
    z-index: 10000;
    font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.chatbot-widget.bottom-right {
    bottom: 20px;
    right: 20px;
}

.chatbot-widget.bottom-left {
    bottom: 20px;
    left: 20px;
}

.chatbot-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--chatbot-primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--chatbot-shadow);
    transition: all 0.3s ease;
    position: relative;
}

.chatbot-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 35px rgba(0,0,0,0.2);
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #ea4335;
    color: white;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chatbot-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 380px;
    height: 500px;
    background: var(--chatbot-background);
    border-radius: 16px;
    box-shadow: var(--chatbot-shadow);
    border: 1px solid var(--chatbot-border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chatbot-header {
    background: var(--chatbot-primary-color);
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.header-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.agent-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.agent-details {
    flex: 1;
}

.agent-name {
    font-weight: 600;
    font-size: 14px;
}

.agent-status {
    font-size: 12px;
    opacity: 0.8;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chatbot-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    scroll-behavior: smooth;
}

.message {
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
}

.user-message {
    align-items: flex-end;
}

.agent-message {
    align-items: flex-start;
}

.message-content {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    line-height: 1.4;
}

.user-message .message-content {
    background: var(--chatbot-primary-color);
    color: white;
    border-bottom-right-radius: 4px;
}

.agent-message .message-content {
    background: #f1f3f4;
    color: var(--chatbot-text);
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 11px;
    color: #5f6368;
    margin-top: 4px;
    padding: 0 16px;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    color: #5f6368;
    font-size: 13px;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #5f6368;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

.chatbot-input {
    border-top: 1px solid var(--chatbot-border);
    padding: 16px;
}

.input-container {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8f9fa;
    border-radius: 24px;
    padding: 8px 12px;
    border: 1px solid #e8eaed;
}

.input-container:focus-within {
    border-color: var(--chatbot-primary-color);
    box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
}

#message-input {
    flex: 1;
    border: none;
    background: none;
    outline: none;
    font-size: 14px;
    line-height: 1.4;
    color: var(--chatbot-text);
}

#message-input::placeholder {
    color: #5f6368;
}

#send-btn {
    background: var(--chatbot-primary-color);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: all 0.2s ease;
}

#send-btn:disabled {
    background: #dadce0;
    cursor: not-allowed;
}

#send-btn:not(:disabled):hover {
    background: #1a73e8;
    transform: scale(1.05);
}

/* Code formatting */
.message-content pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    margin: 8px 0;
}

.message-content code {
    background: #f1f3f4;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
}

.message-content a {
    color: var(--chatbot-primary-color);
    text-decoration: none;
}

.message-content a:hover {
    text-decoration: underline;
}

/* Responsive design */
@media (max-width: 480px) {
    .chatbot-window {
        width: calc(100vw - 40px);
        height: calc(100vh - 120px);
        bottom: 80px;
        right: 20px;
    }
    
    .chatbot-widget.bottom-left .chatbot-window {
        left: 20px;
        right: auto;
    }
}

/* Dark theme support */
.chatbot-widget.dark {
    --chatbot-background: #1f1f1f;
    --chatbot-text: #e8eaed;
    --chatbot-border: #5f6368;
}

.chatbot-widget.dark .agent-message .message-content {
    background: #3c4043;
    color: #e8eaed;
}

.chatbot-widget.dark .input-container {
    background: #3c4043;
    border-color: #5f6368;
}

.chatbot-widget.dark .message-content code {
    background: #5f6368;
    color: #e8eaed;
}</code></pre>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <h4><i class="fas fa-lightbulb"></i> Widget Integration</h4>
                        <p>To integrate the widget into any website, clients just need to add:</p>
                        <div class="code-block">
                            <div class="code-header">Website Integration Code</div>
                            <pre><code class="language-html">&lt;!-- Add to website head --&gt;
&lt;link rel="stylesheet" href="https://YOUR_PROJECT_ID.web.app/chatbot-styles.css"&gt;
&lt;script src="https://YOUR_PROJECT_ID.web.app/chatbot-widget.js"&gt;&lt;/script&gt;

&lt;!-- Initialize chatbot --&gt;
&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
    new MultiTenantChatbot({
        tenantId: 'your-tenant-id', // Auto-detected if not provided
        primaryColor: '#your-brand-color',
        position: 'bottom-right'
    });
});
&lt;/script&gt;</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="timeline">
                <div class="timeline-item active">
                    <h5>Week 1-2</h5>
                    <p>Setup & Core Infrastructure</p>
                </div>
                <div class="timeline-item">
                    <h5>Week 3-4</h5>
                    <p>Agent Development</p>
                </div>
                <div class="timeline-item">
                    <h5>Week 5-6</h5>
                    <p>Frontend & Testing</p>
                </div>
                <div class="timeline-item">
                    <h5>Week 7-8</h5>
                    <p>Deployment & Launch</p>
                </div>
            </div>
            
            <div class="info-box">
                <h4><i class="fas fa-rocket"></i> Next Steps</h4>
                <p>Continue with the deployment section to learn how to deploy your multi-agent system to Google Cloud and make it live for your clients.</p>
            </div>
        </div>
    </div>
    
    <div id="deployment" class="step-section">
        <div class="step-header">
            <h3 class="step-title">
                <span class="step-number">5</span>
                Infrastructure & CI/CD Pipeline Setup
            </h3>
            <p class="step-description">
                Set up production infrastructure, CI/CD pipelines, and monitoring for automated deployment and scaling.
            </p>
        </div>
        <div class="step-content">
            <div class="substep">
                <h4><i class="fas fa-cloud substep-icon"></i> Production Infrastructure</h4>
                <div class="code-block">
                    <div class="code-header">terraform/main.tf - Infrastructure as Code</div>
                    <pre><code># Terraform configuration for production deployment
terraform {
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 4.0"
    }
  }
  
  backend "gcs" {
    bucket = "your-terraform-state-bucket"
    prefix = "chatbot/state"
  }
}

provider "google" {
  project = var.project_id
  region  = var.region
}

# Production Cloud Run Service
resource "google_cloud_run_service" "chatbot_api" {
  name     = "chatbot-api-prod"
  location = var.region

  template {
    spec {
      containers {
        image = "gcr.io/${var.project_id}/chatbot-api:latest"
        
        env {
          name  = "ENVIRONMENT"
          value = "production"
        }
        
        env {
          name = "DATABASE_URL"
          value_from {
            secret_key_ref {
              name = "database-url"
              key  = "url"
            }
          }
        }
        
        resources {
          limits = {
            cpu    = "2000m"
            memory = "1Gi"
          }
        }
      }
    }
    
    metadata {
      annotations = {
        "autoscaling.knative.dev/maxScale" = "100"
        "autoscaling.knative.dev/minScale" = "5"
        "run.googleapis.com/cpu-throttling" = "false"
      }
    }
  }

  traffic {
    percent         = 100
    latest_revision = true
  }
}

# Load Balancer with SSL
resource "google_compute_global_address" "chatbot_ip" {
  name = "chatbot-global-ip"
}

resource "google_compute_managed_ssl_certificate" "chatbot_ssl" {
  name = "chatbot-ssl-cert"

  managed {
    domains = ["api.yourchatbot.com", "admin.yourchatbot.com"]
  }
}

# CDN Configuration
resource "google_compute_backend_service" "chatbot_backend" {
  name        = "chatbot-backend"
  description = "Backend service for chatbot API"
  
  backend {
    group = google_compute_region_network_endpoint_group.chatbot_neg.id
  }
  
  health_checks = [google_compute_health_check.chatbot_health.id]
  
  enable_cdn = true
  cdn_policy {
    cache_mode = "CACHE_ALL_STATIC"
    default_ttl = 3600
    max_ttl = 86400
  }
}</code></pre>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-code-branch substep-icon"></i> CI/CD Pipeline with Cloud Build</h4>
                <div class="code-block">
                    <div class="code-header">cloudbuild.yaml - Complete CI/CD Pipeline</div>
                    <pre><code>steps:
  # Step 1: Run tests
  - name: 'node:18'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Installing dependencies..."
        cd frontend
        npm ci
        npm run test:ci
        npm run build
        
  - name: 'python:3.11'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Running Python tests..."
        cd backend
        pip install -r requirements.txt
        python -m pytest tests/ -v --cov=. --cov-report=xml
        
  # Step 2: Build Docker images
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/chatbot-api:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/chatbot-api:latest'
      - './backend'
      
  # Step 3: Push to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'push'
      - 'gcr.io/$PROJECT_ID/chatbot-api:$COMMIT_SHA'
      
  # Step 4: Deploy to staging
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$BRANCH_NAME" = "develop" ]; then
          echo "Deploying to staging..."
          gcloud run deploy chatbot-api-staging \
            --image gcr.io/$PROJECT_ID/chatbot-api:$COMMIT_SHA \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated
        fi
        
  # Step 5: Deploy to production
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$BRANCH_NAME" = "main" ]; then
          echo "Deploying to production..."
          gcloud run deploy chatbot-api-prod \
            --image gcr.io/$PROJECT_ID/chatbot-api:$COMMIT_SHA \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated
        fi

timeout: '1200s'</code></pre>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-chart-line substep-icon"></i> Monitoring & Alerting Setup</h4>
                <div class="code-block">
                    <div class="code-header">monitoring/alerts.py - Production Monitoring</div>
                    <pre><code>from google.cloud import monitoring_v3
import json

def setup_production_monitoring(project_id):
    """Set up comprehensive production monitoring"""
    
    client = monitoring_v3.AlertPolicyServiceClient()
    project_name = f"projects/{project_id}"
    
    # High error rate alert
    error_rate_policy = {
        "displayName": "High Error Rate - Chatbot API",
        "conditions": [{
            "displayName": "Error rate > 5%",
            "conditionThreshold": {
                "filter": 'resource.type="cloud_run_revision"',
                "comparison": "COMPARISON_GT",
                "thresholdValue": 0.05,
                "duration": {"seconds": 300}
            }
        }],
        "combiner": "OR",
        "enabled": True
    }
    
    # High latency alert
    latency_policy = {
        "displayName": "High Latency - Chatbot API", 
        "conditions": [{
            "displayName": "95th percentile latency > 2s",
            "conditionThreshold": {
                "filter": 'resource.type="cloud_run_revision"',
                "comparison": "COMPARISON_GT",
                "thresholdValue": 2000,
                "duration": {"seconds": 300}
            }
        }],
        "combiner": "OR",
        "enabled": True
    }
    
    # Create alert policies
    for policy in [error_rate_policy, latency_policy]:
        created_policy = client.create_alert_policy(
            parent=project_name,
            alert_policy=policy
        )
        print(f"Created alert policy: {created_policy.displayName}")

if __name__ == "__main__":
    setup_production_monitoring("your-project-id")</code></pre>
                </div>
            </div>
        </div>
    </div>
    
    <div id="timeline" class="step-section">
        <div class="step-header">
            <h3 class="step-title">
                <span class="step-number">6</span>
                Detailed Week-by-Week Implementation
            </h3>
            <p class="step-description">
                Complete 8-week implementation timeline with specific deliverables and milestones.
            </p>
        </div>
        <div class="step-content">
            <div class="substep">
                <h4><i class="fas fa-calendar substep-icon"></i> Week 3-4: Agent Development</h4>
                <div class="command-list">
                    <li>
                        <strong>Day 15-17: Agent Router Implementation</strong>
                        <p>Build intelligent routing with intent classification, context management, and fallback logic</p>
                    </li>
                    <li>
                        <strong>Day 18-20: Support Agent Development</strong>
                        <p>Implement customer service agent with knowledge base integration, escalation workflows</p>
                    </li>
                    <li>
                        <strong>Day 21-23: Sales Agent Development</strong>
                        <p>Build sales-focused agent with lead qualification, CRM integration, quote generation</p>
                    </li>
                    <li>
                        <strong>Day 24-26: Technical Agent Development</strong>
                        <p>Create technical support agent with API documentation, complex query handling</p>
                    </li>
                    <li>
                        <strong>Day 27-28: Agent Integration & Testing</strong>
                        <p>Integration testing, performance optimization, confidence score calibration</p>
                    </li>
                    <li>
                        <strong>Week 4 Deliverable: ‚úÖ Complete multi-agent system with routing</strong>
                        <p>All four agents working together with intelligent routing and tenant isolation</p>
                    </li>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-desktop substep-icon"></i> Week 5-6: Frontend & Testing</h4>
                <div class="command-list">
                    <li>
                        <strong>Day 29-31: Universal Widget Development</strong>
                        <p>Build responsive chatbot widget with tenant auto-detection, custom branding</p>
                    </li>
                    <li>
                        <strong>Day 32-34: Admin Dashboard Creation</strong>
                        <p>Develop tenant management dashboard with analytics, configuration panels</p>
                    </li>
                    <li>
                        <strong>Day 35-37: WordPress Plugin Development</strong>
                        <p>Create WordPress plugin with shortcodes, settings, and easy integration</p>
                    </li>
                    <li>
                        <strong>Day 38-40: Comprehensive Testing Suite</strong>
                        <p>Unit tests, integration tests, end-to-end testing, load testing implementation</p>
                    </li>
                    <li>
                        <strong>Day 41-42: Performance Optimization</strong>
                        <p>API response optimization, caching implementation, CDN configuration</p>
                    </li>
                    <li>
                        <strong>Week 6 Deliverable: ‚úÖ Complete frontend with full test coverage</strong>
                        <p>Working widget, admin dashboard, WordPress plugin, comprehensive test automation</p>
                    </li>
                </div>
            </div>
            
            <div class="substep">
                <h4><i class="fas fa-rocket substep-icon"></i> Week 7-8: Deployment & Launch</h4>
                <div class="command-list">
                    <li>
                        <strong>Day 43-45: Production Infrastructure Setup</strong>
                        <p>Deploy with Terraform, configure load balancing, SSL certificates, DNS</p>
                    </li>
                    <li>
                        <strong>Day 46-48: CI/CD Pipeline Implementation</strong>
                        <p>Cloud Build configuration, automated testing, staging/production deployment</p>
                    </li>
                    <li>
                        <strong>Day 49-51: Security & Compliance</strong>
                        <p>Security audit, vulnerability scanning, compliance checks, access controls</p>
                    </li>
                    <li>
                        <strong>Day 52-54: Monitoring & Alerting</strong>
                        <p>Production monitoring setup, alerting policies, dashboards, log aggregation</p>
                    </li>
                    <li>
                        <strong>Day 55-56: Launch & Onboarding</strong>
                        <p>Final testing, documentation, first tenant onboarding, team training</p>
                    </li>
                    <li>
                        <strong>Week 8 Deliverable: ‚úÖ Live production system serving customers</strong>
                        <p>Fully operational chatbot with monitoring, multiple tenants, support processes</p>
                    </li>
                </div>
            </div>
            
            <div class="warning-box">
                <h4><i class="fas fa-clock"></i> Implementation Tips</h4>
                <ul>
                    <li><strong>Daily Standups:</strong> Track progress and blockers with daily team check-ins</li>
                    <li><strong>Testing First:</strong> Don't skip testing phases - they prevent expensive production issues</li>
                    <li><strong>Documentation:</strong> Document as you build - it's harder to do retrospectively</li>
                    <li><strong>Security Review:</strong> Conduct security reviews at each phase milestone</li>
                </ul>
            </div>
            
            <div class="enterprise-box">
                <h4><i class="fas fa-trophy"></i> Post-Launch Success Metrics</h4>
                <p>Track these KPIs to measure your implementation success:</p>
                <ul>
                    <li><strong>System Performance:</strong> 99.9% uptime, <200ms response time</li>
                    <li><strong>Agent Effectiveness:</strong> >80% confidence scores, <15% escalation rate</li>
                    <li><strong>Business Impact:</strong> Customer satisfaction scores, support cost reduction</li>
                    <li><strong>Technical Metrics:</strong> Error rates <1%, successful deployments >95%</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Back to Portfolio -->
    <a href="../../index.html" class="back-to-portfolio" title="Back to Portfolio" aria-label="Back to Portfolio"><i class="fas fa-home"></i><span>Portfolio</span></a>
    <style>.back-to-portfolio{position:fixed;bottom:28px;right:28px;display:flex;align-items:center;gap:8px;background:linear-gradient(135deg,#00f7ff 0%,#0073ff 100%);color:#050714;padding:12px 22px;border-radius:50px;text-decoration:none;font-weight:700;font-size:14px;letter-spacing:.3px;box-shadow:0 4px 20px rgba(0,247,255,.4),0 0 0 1px rgba(0,247,255,.15);z-index:99999;transition:transform .25s ease,box-shadow .25s ease;font-family:'Inter','Segoe UI',Tahoma,sans-serif;}.back-to-portfolio:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 10px 35px rgba(0,247,255,.55),0 0 0 1px rgba(0,247,255,.3);}.back-to-portfolio i{font-size:14px;}</style>
</body>
</html> 